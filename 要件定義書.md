# xls2xlsx 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
**xls2xlsx - Excel旧形式から新形式への変換ツール**

### 1.2 目的
Excel旧形式（XLS）を新形式（XLSX）に変換するサーバーレスツールをAzure Functions上に構築し、HTTPリクエストおよびBlob Storageトリガーによる自動変換機能を提供する。

### 1.3 プロジェクト範囲
- HTTPトリガー関数によるREST API形式の変換機能
- Azure Blob Storageトリガーによる自動変換機能
- 小容量ファイル（10MB未満）は直接レスポンス、大容量ファイルはBlob Storage経由でのダウンロードURL提供
- 複数シートを含むExcelファイルの完全変換

### 1.4 対象ユーザー
- Excel旧形式ファイルをバッチ/自動で変換したい企業・組織
- REST API経由でファイル変換を行いたい開発者
- Azure環境を活用したサーバーレスソリューションを求める技術者

---

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 HTTPトリガー関数（convert_http）

| 要件ID | 要件名 | 詳細 | 優先度 |
|--------|--------|------|--------|
| F-HTTP-001 | ファイルアップロード受付 | POSTリクエストでXLSファイルをバイナリ形式で受け付ける | 必須 |
| F-HTTP-002 | ファイル名指定 | リクエストヘッダー `X-Filename` からファイル名を取得 | 必須 |
| F-HTTP-003 | XLS→XLSX変換 | pandas + xlrd + openpyxlを使用してXLSをXLSXに変換 | 必須 |
| F-HTTP-004 | 複数シート対応 | 全シートを変換し、同じシート名でXLSXに保存 | 必須 |
| F-HTTP-005 | 小容量ファイル直接レスポンス | 10MB未満のファイルはHTTPレスポンスで直接返却 | 必須 |
| F-HTTP-006 | 大容量ファイルURL提供 | 10MB以上のファイルはBlob Storageに保存し、SAS付きダウンロードURLを返却 | 必須 |
| F-HTTP-007 | SASトークン期限 | ダウンロードURLのSASトークンは1時間有効 | 必須 |
| F-HTTP-008 | エラーハンドリング | 変換失敗時は適切なHTTPステータスコードとエラーメッセージを返す | 必須 |

#### 2.1.2 Blobトリガー関数（convert_blob）

| 要件ID | 要件名 | 詳細 | 優先度 |
|--------|--------|------|--------|
| F-BLOB-001 | 自動変換トリガー | `xls-input` コンテナへのファイルアップロードで自動実行 | 必須 |
| F-BLOB-002 | ファイル形式検証 | .xls拡張子のファイルのみ処理、その他はスキップ | 必須 |
| F-BLOB-003 | XLS→XLSX変換 | HTTPトリガーと同じロジックで変換 | 必須 |
| F-BLOB-004 | 出力先保存 | 変換結果を `xls-output` コンテナに保存 | 必須 |
| F-BLOB-005 | ファイル名変換 | 入力ファイル名の拡張子を.xlsから.xlsxに変更 | 必須 |
| F-BLOB-006 | ログ出力 | 処理開始、完了、エラー時にログを出力 | 必須 |
| F-BLOB-007 | エラーハンドリング | 変換失敗時は例外をログに記録し、再スロー | 必須 |

#### 2.1.3 共通変換ロジック

| 要件ID | 要件名 | 詳細 | 優先度 |
|--------|--------|------|--------|
| F-CONV-001 | XLS読み込み | xlrdエンジンを使用してXLSファイルを読み込み | 必須 |
| F-CONV-002 | DataFrame変換 | pandasでDataFrameとして中間処理 | 必須 |
| F-CONV-003 | XLSX書き込み | openpyxlエンジンを使用してXLSXファイルを生成 | 必須 |
| F-CONV-004 | インデックス非保存 | DataFrameのインデックスは出力しない（index=False） | 必須 |
| F-CONV-005 | バイナリ処理 | メモリ上でバイナリデータとして処理（ディスクI/O不要） | 必須 |

### 2.2 非機能要件

#### 2.2.1 パフォーマンス

| 要件ID | 要件名 | 詳細 | 目標値 |
|--------|--------|------|--------|
| N-PERF-001 | HTTPレスポンス時間 | 10MB未満のファイル変換 | 30秒以内 |
| N-PERF-002 | HTTPタイムアウト制限 | Azure Load Balancerの制限 | 230秒（固定） |
| N-PERF-003 | 関数タイムアウト | 従量課金プランでの最大実行時間 | 5分（デフォルト）、最大10分 |
| N-PERF-004 | 最大リクエストサイズ | HTTPトリガーの最大受付サイズ | 210MB |
| N-PERF-005 | Blob並列処理 | Blobトリガーの同時処理数 | 4ファイル |

#### 2.2.2 可用性・信頼性

| 要件ID | 要件名 | 詳細 | 目標値 |
|--------|--------|------|--------|
| N-AVAIL-001 | サービス稼働率 | Azure Functionsの稼働率 | 99.95%（Azureの保証） |
| N-AVAIL-002 | エラーリトライ | Blobトリガーの自動リトライ | 5回（Azure標準） |
| N-AVAIL-003 | データ永続化 | 変換済みファイルの保存期間 | ライフサイクルポリシーで管理 |

#### 2.2.3 セキュリティ

| 要件ID | 要件名 | 詳細 | 優先度 | 実装状況 |
|--------|--------|------|--------|----------|
| N-SEC-001 | 関数認証 | HTTPトリガーは関数キー認証 | 必須 | ✅ 実装済み |
| N-SEC-002 | Blob接続 | ストレージアクセスはマネージドID推奨（接続文字列も可） | 推奨 | ✅ 接続文字列で実装 |
| N-SEC-003 | SASトークン | ダウンロードURLは読み取り専用、期限付きSAS（1時間） | 必須 | ✅ 実装済み |
| N-SEC-004 | ネットワーク制限 | 本番環境ではIP制限の設定を推奨 | 推奨 | ⚠️ 要設定 |
| N-SEC-005 | 入力バリデーション | ファイルサイズ、形式の検証 | 必須 | ✅ **実装済み**（2025-11-20） |
| N-SEC-006 | ファイル名サニタイズ | パストラバーサル対策 | 必須 | ✅ **実装済み**（2025-11-20） |
| N-SEC-007 | セキュリティヘッダー | HSTS, CSP, X-Frame-Options等 | 必須 | ✅ **実装済み**（2025-11-20） |
| N-SEC-008 | エラーメッセージ処理 | 本番環境で詳細情報を隠蔽 | 必須 | ✅ **実装済み**（2025-11-20） |
| N-SEC-009 | セキュリティログ | 不正アクセス試行の記録 | 推奨 | ✅ **実装済み**（2025-11-20） |
| N-SEC-010 | プライベートStorage | パブリックアクセス無効化 | 必須 | ✅ **実装済み**（2025-11-20） |

#### 2.2.4 運用性

| 要件ID | 要件名 | 詳細 | 優先度 |
|--------|--------|------|--------|
| N-OPS-001 | ログ出力 | 処理開始、完了、エラーをApplication Insightsに記録 | 必須 |
| N-OPS-002 | モニタリング | 実行履歴、メトリクスの可視化 | 必須 |
| N-OPS-003 | アラート設定 | エラー率、実行時間の閾値監視 | 推奨 |

#### 2.2.5 拡張性

| 要件ID | 要件名 | 詳細 | 優先度 |
|--------|--------|------|--------|
| N-SCAL-001 | 自動スケーリング | 従量課金プランによる自動スケールアウト | 必須 |
| N-SCAL-002 | Premium プラン対応 | コールドスタート回避のためのPremium プラン移行可能性 | 任意 |

---

## 3. システム構成

### 3.1 システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    Azure Functions                      │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │ HTTP Trigger    │    │ Blob Trigger    │             │
│  │ (convert_http)  │    │ (convert_blob)  │             │
│  └────────┬────────┘    └────────┬────────┘             │
│           │                      │                      │
│           ▼                      ▼                      │
│  ┌─────────────────────────────────────────┐            │
│  │      変換ロジック (pandas + openpyxl)    │            │
│  └─────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
              ┌─────────────────────┐
              │  Azure Blob Storage │
              │  - xls-input/       │
              │  - xls-output/      │
              └─────────────────────┘
```

### 3.2 Azureリソース

| リソース種別 | 名前 | 用途 | 設定 |
|------------|------|------|------|
| Resource Group | rg-xls-converter | リソースのグループ化 | Region: Japan East |
| Storage Account | stxlsconverter | ファイル保存、関数実行環境 | Standard LRS |
| Blob Container | xls-input | 入力XLSファイル保存 | プライベート |
| Blob Container | xls-output | 出力XLSXファイル保存 | プライベート |
| Function App | func-xls-converter | 関数実行環境 | Python 3.11, Linux, 従量課金 |

### 3.3 技術スタック

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| ランタイム | Python | 3.10〜3.12 | 関数実行環境 |
| プラットフォーム | Azure Functions | v4 | サーバーレス実行基盤 |
| データ処理 | pandas | 最新 | DataFrame操作 |
| Excel書き込み | openpyxl | 最新 | XLSX形式書き込み |
| Excel読み込み | xlrd | 最新 | XLS形式読み込み |
| ストレージSDK | azure-storage-blob | 最新 | Blob操作 |

---

## 4. プロジェクト構造

```
xls-converter/
├── .venv/                      # Python仮想環境
├── .vscode/                    # VS Code設定
│   └── settings.json
├── convert_http/               # HTTPトリガー関数
│   ├── __init__.py            # 関数実装
│   └── function.json          # 関数バインディング定義
├── convert_blob/               # Blobトリガー関数
│   ├── __init__.py            # 関数実装
│   └── function.json          # 関数バインディング定義
├── host.json                   # ホスト設定
├── local.settings.json         # ローカル環境変数
└── requirements.txt            # 依存パッケージ
```

---

## 5. インターフェース仕様

### 5.1 HTTPトリガーAPI

#### エンドポイント
- **URL**: `https://func-xls-converter.azurewebsites.net/api/convert_http`
- **メソッド**: POST
- **認証**: 関数キー（クエリパラメータ `code` または `x-functions-key` ヘッダー）

#### リクエスト

```http
POST /api/convert_http?code={関数キー} HTTP/1.1
Host: func-xls-converter.azurewebsites.net
Content-Type: application/octet-stream
X-Filename: sample.xls

{バイナリデータ}
```

| ヘッダー | 必須 | 説明 |
|---------|------|------|
| X-Filename | 任意 | ファイル名（省略時は "converted" を使用） |

#### レスポンス（10MB未満）

```http
HTTP/1.1 200 OK
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="sample.xlsx"

{XLSXバイナリデータ}
```

#### レスポンス（10MB以上）

```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "download_url": "https://stxlsconverter.blob.core.windows.net/xls-output/sample.xlsx?{SASトークン}"
}
```

#### エラーレスポンス

| ステータスコード | 条件 | メッセージ例 |
|----------------|------|-------------|
| 400 | リクエストボディが空 | "リクエストボディにXLSファイルが含まれていません。" |
| 413 | ファイルサイズ超過（推奨実装） | "ファイルサイズが上限を超えています（最大50MB）" |
| 500 | 変換エラー | "変換中にエラーが発生しました: {詳細}" |

### 5.2 Blobトリガー

#### トリガー条件
- **コンテナ**: `xls-input`
- **パス**: `{name}` （すべてのファイル）
- **フィルタ**: .xls拡張子のみ処理

#### 処理フロー
1. `xls-input` にファイルがアップロードされる
2. 拡張子が .xls でない場合はスキップ
3. XLS→XLSX変換を実行
4. `xls-output` に {元のファイル名}.xlsx として保存

#### 出力
- **コンテナ**: `xls-output`
- **ファイル名**: 元のファイル名の拡張子を .xlsx に変更

---

## 6. 設定ファイル仕様

### 6.1 requirements.txt

```plaintext
azure-functions
pandas
openpyxl
xlrd
azure-storage-blob
```

### 6.2 host.json

```json
{
  "version": "2.0",
  "logging": {
    "applicationInsights": {
      "samplingSettings": {
        "isEnabled": true,
        "excludedTypes": "Request"
      }
    }
  },
  "extensionBundle": {
    "id": "Microsoft.Azure.Functions.ExtensionBundle",
    "version": "[4.*, 5.0.0)"
  },
  "extensions": {
    "http": {
      "maxRequestBodySize": 209715200,
      "routePrefix": "api"
    },
    "blobs": {
      "maxDegreeOfParallelism": 4
    }
  },
  "functionTimeout": "00:05:00"
}
```

### 6.3 local.settings.json

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "<ストレージ接続文字列>",
    "FUNCTIONS_WORKER_RUNTIME": "python"
  }
}
```

### 6.4 function.json（convert_http）

```json
{
  "scriptFile": "__init__.py",
  "bindings": [
    {
      "authLevel": "function",
      "type": "httpTrigger",
      "direction": "in",
      "name": "req",
      "methods": ["post"]
    },
    {
      "type": "http",
      "direction": "out",
      "name": "$return"
    }
  ]
}
```

### 6.5 function.json（convert_blob）

```json
{
  "scriptFile": "__init__.py",
  "bindings": [
    {
      "name": "inputblob",
      "type": "blobTrigger",
      "direction": "in",
      "path": "xls-input/{name}",
      "connection": "AzureWebJobsStorage"
    }
  ]
}
```

---

## 7. テスト要件

### 7.1 単体テスト

| テストID | テスト項目 | 入力 | 期待結果 |
|---------|-----------|------|---------|
| UT-001 | 単一シートXLS変換 | 1シートのXLSファイル | XLSX形式で同一データが出力される |
| UT-002 | 複数シートXLS変換 | 3シートのXLSファイル | 全シートがXLSX形式で出力される |
| UT-003 | 空ファイルエラー | 空のリクエストボディ | 400エラーが返る |
| UT-004 | 不正形式エラー | PDFファイル | 500エラーまたは適切なエラーメッセージ |
| UT-005 | ファイル名取得 | X-Filename: "test.xls" | 出力ファイル名が "test.xlsx" |
| UT-006 | ファイル名省略 | ヘッダーなし | 出力ファイル名が "converted.xlsx" |

### 7.2 統合テスト

| テストID | テスト項目 | 入力 | 期待結果 |
|---------|-----------|------|---------|
| IT-001 | HTTPトリガー（小容量） | 5MBのXLSファイル | レスポンスボディにXLSXが返る |
| IT-002 | HTTPトリガー（大容量） | 15MBのXLSファイル | JSONでダウンロードURLが返る |
| IT-003 | Blobトリガー | xls-inputにアップロード | xls-outputに変換結果が保存される |
| IT-004 | Blobトリガー（非XLS） | test.pdfをアップロード | 処理されずスキップされる |
| IT-005 | SASトークン有効期限 | URLアクセス | 1時間以内はダウンロード可、1時間後は403エラー |

### 7.3 性能テスト

| テストID | テスト項目 | 負荷条件 | 目標値 |
|---------|-----------|---------|--------|
| PT-001 | 小容量ファイル処理時間 | 1MBのXLSファイル | 10秒以内 |
| PT-002 | 中容量ファイル処理時間 | 10MBのXLSファイル | 30秒以内 |
| PT-003 | 同時処理性能 | 10リクエスト同時 | 自動スケールで処理完了 |

---

## 8. エラーハンドリング

### 8.1 エラーカテゴリ

| カテゴリ | 原因例 | 対処 |
|---------|--------|------|
| 入力エラー | ファイルなし、不正形式 | 400エラー、エラーメッセージ返却 |
| 変換エラー | pandas/xlrd例外 | 500エラー、ログ記録 |
| ストレージエラー | Blob接続失敗 | 500エラー、リトライ |
| タイムアウト | 処理時間超過 | 504エラー、ログ記録 |

### 8.2 ログ出力項目

- 処理開始時刻
- 入力ファイル名
- ファイルサイズ
- 処理完了時刻
- エラー詳細（エラー時）

---

## 9. デプロイ・運用

### 9.1 デプロイ方法

1. **VS Codeからのデプロイ**（推奨）
   - Azure Functions拡張機能の「Deploy to Function App」を使用

2. **Azure CLIからのデプロイ**
   ```bash
   func azure functionapp publish func-xls-converter
   ```

3. **GitHub Actions CI/CD**（任意）
   - プッシュ時の自動デプロイ

### 9.2 環境変数

| 変数名 | 説明 | 設定先 |
|--------|------|--------|
| AzureWebJobsStorage | ストレージ接続文字列 | アプリケーション設定 |
| FUNCTIONS_WORKER_RUNTIME | ランタイム指定 | アプリケーション設定 |

### 9.3 監視項目

- 実行回数
- 成功/失敗率
- 平均実行時間
- エラーログ
- ストレージ使用量

---

## 10. 制約事項・前提条件

### 10.1 制約事項

| 項目 | 制約内容 |
|------|---------|
| HTTPリクエストサイズ | 最大210MB |
| HTTPレスポンスタイムアウト | 230秒（Azure Load Balancer制限） |
| 関数実行タイムアウト | 従量課金プランで最大10分 |
| XLS形式 | xlrd 2.0以降は .xls のみサポート（.xlsx非対応） |
| Python バージョン | 従量課金プランでは 3.13 は非対応 |

### 10.2 前提条件

- Azureサブスクリプションが有効である
- ストレージアカウント、Function Appが作成済みである
- ローカル開発環境にPython 3.10〜3.12がインストール済みである
- Azure Functions Core Tools v4がインストール済みである

---

## 11. セキュリティ要件（✅ 実装完了 - 2025-11-20）

**セキュリティスコア**: 9.5/10 ⭐

### 11.1 実装済みセキュリティ機能

#### 11.1.1 入力検証・サニタイズ

| 機能 | 実装内容 | ファイル |
|------|---------|---------|
| ファイル名サニタイズ | パストラバーサル対策、特殊文字除去、255文字制限 | `security_utils.py::sanitize_filename()` |
| ファイルサイズ検証 | 50MB上限、空ファイル拒否 | `security_utils.py::validate_file_size()` |
| ファイル形式検証 | XLSマジックナンバーチェック (`\xD0\xCF\x11\xE0`) | `security_utils.py::validate_xls_format()` |
| シート数制限 | 最大100シート（DoS対策） | `convert_http/__init__.py`, `convert_blob/__init__.py` |
| データサイズチェック | 100万行超過で警告 | `convert_http/__init__.py`, `convert_blob/__init__.py` |

#### 11.1.2 セキュリティヘッダー

| ヘッダー | 設定値 | 効果 |
|---------|-------|------|
| X-Content-Type-Options | nosniff | MIME型スニッフィング防止 |
| X-Frame-Options | DENY | クリックジャッキング防止 |
| X-XSS-Protection | 1; mode=block | XSS攻撃緩和 |
| Strict-Transport-Security | max-age=31536000; includeSubDomains | HTTPS強制 |
| Content-Security-Policy | default-src 'self' | スクリプト実行制限 |

実装: `security_utils.py::get_security_headers()`

#### 11.1.3 エラーハンドリング

| 環境 | 動作 | 実装 |
|------|------|------|
| 本番環境 | 詳細なスタックトレースを隠蔽、一般的なエラーメッセージ表示 | `sanitize_error_message(is_production=True)` |
| 開発環境 | 詳細なエラー情報を表示 | `sanitize_error_message(is_production=False)` |

#### 11.1.4 セキュリティログ

```python
# セキュリティイベントの記録
log_security_event('validation_failed', {
    'reason': error_message,
    'original_filename': raw_filename,
    'file_size': len(file_data),
    'ip': req.headers.get('X-Forwarded-For')
})
```

実装: `security_utils.py::log_security_event()`

#### 11.1.5 認証・アクセス制御

| 項目 | 実装内容 | 状態 |
|------|---------|------|
| HTTPトリガー認証 | Function Key認証（function.json） | ✅ 実装済み |
| Blob Storage | プライベートアクセス、パブリックアクセス無効化 | ✅ 実装済み |
| SASトークン | 読み取り専用、1時間有効期限 | ✅ 実装済み |
| IP制限 | Azure Portal設定（本番環境推奨） | ⚠️ 要設定 |

### 11.2 セキュリティテスト結果

**実施日**: 2025-11-20  
**結果**: ✅ 6/6テスト成功（100%）

| テスト項目 | 結果 |
|-----------|------|
| ファイル名サニタイズ | ✅ 6/6ケース成功 |
| ファイルサイズ検証 | ✅ 5/5ケース成功 |
| XLSフォーマット検証 | ✅ 4/4ケース成功 |
| セキュリティヘッダー | ✅ 5/5ヘッダー確認 |
| エラーメッセージ | ✅ 2/2環境別処理確認 |
| 総合入力検証 | ✅ 4/4シナリオ成功 |

詳細: `SECURITY_AUDIT.md`, `SECURITY_IMPLEMENTATION.md`

### 11.3 対策済み脆弱性

| 脆弱性 | 対策 | 効果 |
|-------|------|------|
| パストラバーサル攻撃 | ファイル名サニタイズ | システムファイルへのアクセス防止 |
| ファイル形式偽装 | マジックナンバーチェック | 悪意あるファイルの実行防止 |
| DoS攻撃（サイズ） | 50MB上限、シート数・行数制限 | リソース枯渇防止 |
| DoS攻撃（CPU） | シート数100、行数100万制限 | 処理時間の制限 |
| 情報漏洩 | エラーメッセージサニタイズ | 内部情報の隠蔽 |
| クリックジャッキング | X-Frame-Options: DENY | iframe埋め込み防止 |
| XSS攻撃 | X-Content-Type-Options | Content-Type推測攻撃防止 |
| CSP違反 | Content-Security-Policy | 外部スクリプト実行防止 |

### 11.4 セキュリティ関連ファイル

| ファイル | 内容 | 行数 |
|---------|------|------|
| `security_utils.py` | セキュリティユーティリティモジュール | 231行 |
| `test_security_features.py` | セキュリティテストスイート | 220行 |
| `SECURITY_AUDIT.md` | セキュリティ監査レポート | 500+行 |
| `SECURITY_IMPLEMENTATION.md` | 実装完了レポート | 200+行 |

### 11.5 本番環境デプロイ前チェックリスト

- [x] セキュリティ機能実装完了
- [x] セキュリティテスト100%成功
- [x] セキュリティ監査実施（スコア9.5/10）
- [ ] Azure環境変数設定（`AZURE_FUNCTIONS_ENVIRONMENT=Production`）
- [ ] Application Insights設定
- [ ] Azure Key Vault設定（接続文字列管理）
- [ ] カスタムドメイン + SSL証明書
- [ ] Azure API Management設定（レート制限）
- [ ] IP制限設定
- [ ] 監視・アラート設定

### 11.6 認証・認可（既存）

| 項目 | 実装内容 | 優先度 |
|------|---------|--------|
| HTTPトリガー認証 | 関数キー必須 | 必須 |
| Azure AD認証 | エンタープライズ環境での実装検討 | 推奨 |
| IP制限 | 許可IPアドレスの設定 | 推奨 |

### 11.7 入力検証（✅ 実装済み）

**実装モジュール**: `security_utils.py`

```python
# ファイルサイズ制限
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB

# XLS形式検証（マジックナンバー）
XLS_MAGIC_NUMBERS = [
    b'\xd0\xcf\x11\xe0',  # OLE2/CFB (Compound File Binary)
    b'\x09\x08\x10\x00\x00\x06\x05\x00',  # BIFF5
]

# 総合入力検証
is_valid, sanitized_filename, error_message = validate_input(file_data, filename)
```

**テスト結果**: ✅ 100%成功（2025-11-20実施）

---

## 12. 拡張性・将来計画

### 12.1 機能拡張候補

| 拡張項目 | 内容 | 優先度 |
|---------|------|--------|
| 複数ファイル一括変換 | ZIPアップロード対応 | 中 |
| XLSX→XLS逆変換 | 逆方向の変換サポート | 低 |
| シート選択変換 | 特定シートのみ変換 | 低 |
| 通知機能 | メール/Teams通知 | 中 |

### 12.2 アーキテクチャ改善候補

| 項目 | 内容 | 効果 |
|------|------|------|
| Durable Functions | 長時間処理の非同期パターン | タイムアウト回避 |
| Premium プラン | コールドスタート削減 | パフォーマンス向上 |
| Application Insights | 詳細な監視・分析 | 運用性向上 |

---

## 13. 成功基準

### 13.1 受入基準

| 項目 | 基準 |
|------|------|
| 機能完成度 | 必須機能（F-HTTP-001〜008、F-BLOB-001〜007）がすべて実装済み |
| テスト完了 | 単体テスト、統合テストがすべて合格 |
| パフォーマンス | 10MBファイルが30秒以内に変換完了 |
| デプロイ成功 | Azure環境で正常に動作 |
| ドキュメント | 手順書、要件定義書が完備 |

### 13.2 品質基準

| 項目 | 目標値 |
|------|--------|
| 変換成功率 | 95%以上（正常なXLSファイル） |
| エラーログカバレッジ | すべてのエラーパスでログ出力 |
| セキュリティ | 関数キー認証が有効 |

---

## 14. プロジェクト体制・スケジュール

### 14.1 開発体制

| 役割 | 責任範囲 |
|------|---------|
| 開発者 | 関数実装、テスト、デプロイ |
| レビュアー | コードレビュー、セキュリティチェック |
| 運用担当 | 監視設定、アラート設定 |

### 14.2 想定スケジュール

| フェーズ | 期間 | 成果物 |
|---------|------|--------|
| 環境構築 | 1日 | Azure環境、ローカル環境 |
| HTTPトリガー実装 | 2日 | convert_http関数 |
| Blobトリガー実装 | 1日 | convert_blob関数 |
| テスト | 2日 | テスト完了報告 |
| デプロイ・動作確認 | 1日 | 本番稼働確認 |

---

## 15. リスク管理

### 15.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| pandasパッケージサイズによるコールドスタート遅延 | 中 | Premium プラン検討、ウォームアップ設定 |
| 大容量ファイルのタイムアウト | 高 | 10MB超はBlob経由、Durable Functions検討 |
| xlrdバージョン互換性 | 低 | requirements.txtでバージョン固定 |

### 15.2 運用リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| ストレージコスト超過 | 中 | ライフサイクルポリシーで古いファイル削除 |
| 関数実行コスト超過 | 低 | 実行回数の監視、アラート設定 |

---

## 16. 参考資料

- [Azure Functions Python開発者ガイド](https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-reference-python)
- [pandas公式ドキュメント](https://pandas.pydata.org/docs/)
- [openpyxl公式ドキュメント](https://openpyxl.readthedocs.io/)
- [xlrd公式ドキュメント](https://xlrd.readthedocs.io/)
- [Azure Blob Storage SDK for Python](https://docs.microsoft.com/ja-jp/azure/storage/blobs/storage-quickstart-blobs-python)

---

## 付録A: 用語集

| 用語 | 説明 |
|------|------|
| XLS | Excel 97-2003形式（バイナリ形式） |
| XLSX | Excel 2007以降形式（Office Open XML形式） |
| Azure Functions | Microsoftのサーバーレスコンピューティングサービス |
| Blob Storage | Azureのオブジェクトストレージサービス |
| SASトークン | Shared Access Signature（期限付きアクセストークン） |
| コールドスタート | 関数の初回起動時の遅延 |
| pandas | Pythonのデータ分析ライブラリ |
| openpyxl | PythonのExcel（XLSX）読み書きライブラリ |
| xlrd | PythonのExcel（XLS）読み込みライブラリ |

---

## 付録B: 変更履歴

| 版数 | 日付 | 変更内容 | 作成者 |
|------|------|---------|--------|
| 1.0 | 2025-11-20 | 初版作成 | - |

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトマネージャー | | | |
| 技術リーダー | | | |
| 品質保証担当 | | | |

---

**END OF DOCUMENT**

